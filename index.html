<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Ø±Ø¯ÛŒØ§Ø¨ Ú©Ø§Ù„Ø±ÛŒ Ùˆ Ù¾Ø±ÙˆØªØ¦ÛŒÙ†</title>

<!-- PWA -->
<link rel="manifest" href="manifest.webmanifest">
<meta name="theme-color" content="#0f172a">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<link rel="apple-touch-icon" href="icons/icon-192.png">

<style>
  :root{
    --bg:#0f172a; --card:#111827; --muted:#94a3b8; --text:#e5e7eb;
    --blue:#3b82f6; --track:#1f2937; --accent:#22c55e; --danger:#ef4444;
  }
  *{box-sizing:border-box}
  body{margin:0; padding:24px; background: radial-gradient(1200px 800px at 100% -10%, #0b1225, var(--bg));
       color:var(--text); font-family:"Vazirmatn",system-ui,-apple-system,Segoe UI,Roboto,"Noto Naskh Arabic",Tahoma,Arial,sans-serif;}
  .container{max-width:760px;margin:0 auto;display:flex;flex-direction:column;gap:18px;}
  .header{display:flex;align-items:flex-start;justify-content:space-between;gap:16px;flex-wrap:wrap}
  h1{margin:0;font-size:22px;font-weight:800;letter-spacing:-0.3px}
  .card{background:linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.01));
        border:1px solid rgba(255,255,255,0.06); border-radius:16px; padding:16px; backdrop-filter: blur(6px);}
  .goals{display:grid;grid-template-columns:1fr;gap:12px;}
  @media (min-width:700px){.goals{grid-template-columns:1fr 1fr;}}
  .progress{display:flex;flex-direction:column;gap:8px;}
  .label-row{display:flex;align-items:baseline;justify-content:space-between;gap:8px;color:var(--muted);font-size:14px;}
  .bar{position:relative;width:100%;height:16px;background:var(--track);border-radius:999px;overflow:hidden;outline:1px solid rgba(255,255,255,0.05);}
  .fill{position:absolute;inset:0 0 0 auto;width:0%;background:linear-gradient(90deg,#60a5fa,var(--blue));
        box-shadow:0 0 12px rgba(59,130,246,.5) inset;border-radius:999px;transition:width .35s ease;}
  .stats{display:flex;gap:10px;flex-wrap:wrap;font-size:13px;color:var(--muted);}
  .pill{padding:6px 10px;border:1px solid rgba(255,255,255,0.08);border-radius:999px;background:rgba(255,255,255,0.03)}
  .form{display:grid;grid-template-columns:1fr;gap:12px;}
  @media (min-width:520px){.form{grid-template-columns:repeat(3,1fr);}}
  .field{display:flex;flex-direction:column;gap:6px;}
  label{font-size:13px;color:var(--muted)}
  input{background:#0b1220;color:var(--text);border:1px solid rgba(255,255,255,0.08);
        border-radius:12px;padding:12px 10px;font-size:16px;outline:none;}
  input:focus{border-color:#60a5fa;box-shadow:0 0 0 4px rgba(59,130,246,.15)}
  .btn{cursor:pointer;border:none;padding:12px 14px;border-radius:12px;font-size:16px;font-weight:700;}
  .btn-primary{background:var(--blue);color:white}
  .btn-danger{background:transparent;color:#fecaca;border:1px dashed rgba(239,68,68,.5)}
  .footer-actions{display:flex;gap:10px;flex-wrap:wrap;justify-content:space-between;align-items:center}
  .hint{color:var(--muted);font-size:12px}
  .log{display:flex;flex-direction:column;gap:8px;max-height:240px;overflow:auto;border-top:1px solid rgba(255,255,255,0.06);padding-top:10px}
  .log-item{display:flex;justify-content:space-between;align-items:center;gap:10px;padding:10px;border:1px solid rgba(255,255,255,0.06);border-radius:12px;background:rgba(255,255,255,0.02);}
  .log-meta{font-size:13px;color:var(--muted)}
  .log-nums{font-weight:700}
  .toast{position:fixed;inset:auto 0 24px 0;display:flex;justify-content:center;pointer-events:none;}
  .toast>div{background:linear-gradient(90deg,#16a34a,#22c55e);color:white;font-weight:900;letter-spacing:.5px;padding:14px 18px;border-radius:999px;box-shadow:0 10px 30px rgba(0,0,0,.35);transform:translateY(32px);opacity:0;transition:all .4s ease;}
  .toast.show>div{transform:translateY(0);opacity:1}
  .tiny{font-size:12px;color:var(--muted)}
  #goalSettings input{background:#0b1220;border:1px solid rgba(255,255,255,.08);color:var(--text)}
</style>
</head>
<body>
<div class="container">
  <div class="header">
    <h1>Ø±Ø¯ÛŒØ§Ø¨ Ø±ÙˆØ²Ø§Ù†Ù‡ Ú©Ø§Ù„Ø±ÛŒ Ùˆ Ù¾Ø±ÙˆØªØ¦ÛŒÙ†</h1>
    <div style="display:flex;gap:10px;align-items:flex-start;flex-wrap:wrap">
      <button id="resetBtn" class="btn btn-danger">Ø±ÛŒØ³Øª</button>
      <div id="goalSettings" style="display:flex;gap:8px;flex-wrap:wrap">
        <input id="goalCal" type="number" min="0" placeholder="Ù‡Ø¯Ù Ú©Ø§Ù„Ø±ÛŒ" style="width:120px;padding:8px;border-radius:8px">
        <input id="goalPro" type="number" min="0" placeholder="Ù‡Ø¯Ù Ù¾Ø±ÙˆØªØ¦ÛŒÙ†" style="width:120px;padding:8px;border-radius:8px">
        <button id="saveGoals" class="btn" style="font-size:13px">Ø°Ø®ÛŒØ±Ù‡ Ù‡Ø¯Ù</button>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="goals">
      <div class="progress" id="calorieSection">
        <div class="label-row">
          <div>Ú©Ø§Ù„Ø±ÛŒ Ø§Ù…Ø±ÙˆØ²</div>
          <div class="tiny"><span id="calorieTotal">0</span> / <span id="calorieGoal">3000</span> Ú©ÛŒÙ„ÙˆÚ©Ø§Ù„Ø±ÛŒ</div>
        </div>
        <div class="bar"><div class="fill" id="calorieFill"></div></div>
        <div class="stats">
          <span class="pill">Ø¨Ø§Ù‚ÛŒâ€ŒÙ…Ø§Ù†Ø¯Ù‡: <b id="calorieRemain">3000</b></span>
          <span class="pill">Ù¾ÛŒØ´Ø±ÙØª: <b id="caloriePercent">0%</b></span>
        </div>
      </div>

      <div class="progress" id="proteinSection">
        <div class="label-row">
          <div>Ù¾Ø±ÙˆØªØ¦ÛŒÙ† Ø§Ù…Ø±ÙˆØ²</div>
          <div class="tiny"><span id="proteinTotal">0</span> / <span id="proteinGoal">176</span> Ú¯Ø±Ù…</div>
        </div>
        <div class="bar"><div class="fill" id="proteinFill"></div></div>
        <div class="stats">
          <span class="pill">Ø¨Ø§Ù‚ÛŒâ€ŒÙ…Ø§Ù†Ø¯Ù‡: <b id="proteinRemain">176</b></span>
          <span class="pill">Ù¾ÛŒØ´Ø±ÙØª: <b id="proteinPercent">0%</b></span>
        </div>
      </div>
    </div>
  </div>

  <div class="card">
    <form id="addForm" class="form" autocomplete="off">
      <div class="field">
        <label for="mealName">Ù†Ø§Ù… ØºØ°Ø§ / ÙˆØ¹Ø¯Ù‡</label>
        <input id="mealName"
               type="text"
               list="foodList"
               placeholder="Ù…Ø«Ù„Ø§Ù‹: Ù…ÙˆØ²ØŒ Ù…Ø§Ù‡ÛŒØŒ ØªØ®Ù…â€ŒÙ…Ø±Øº..."
               autocomplete="off"
               autocapitalize="off"
               autocorrect="off"
               spellcheck="false" />
        <datalist id="foodList"></datalist>
        <div class="tiny">Ù†Ú©ØªÙ‡: ÙÙ‚Ø· ÙˆÙ‚ØªÛŒ Ø§Ø² ÙÙ‡Ø±Ø³Øª Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒ ÛŒØ§ Ø¯Ú©Ù…Ù‡ Â«âš¡ Ù¾Ø±Ú©Ø±Ø¯Ù† Ø®ÙˆØ¯Ú©Ø§Ø±Â» Ø±Ø§ Ø¨Ø²Ù†ÛŒØŒ Ù…Ù‚Ø§Ø¯ÛŒØ± Ù¾Ø± Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯.</div>
      </div>

      <div class="field">
        <label for="calories">Ú©Ø§Ù„Ø±ÛŒ (Ú©ÛŒÙ„ÙˆÚ©Ø§Ù„Ø±ÛŒ)</label>
        <input id="calories" inputmode="decimal" type="number" min="0" step="1" placeholder="Ù…Ø«Ù„Ø§Ù‹ Û±Û°Ûµ" required />
      </div>

      <div class="field">
        <label for="protein">Ù¾Ø±ÙˆØªØ¦ÛŒÙ† (Ú¯Ø±Ù…)</label>
        <input id="protein" inputmode="decimal" type="number" min="0" step="0.1" placeholder="Ù…Ø«Ù„Ø§Ù‹ Û±Ù«Û³" required />
      </div>

      <button class="btn btn-primary" type="submit" style="grid-column: 1 / -1">Ø§ÙØ²ÙˆØ¯Ù† Ø¨Ù‡ Ù„ÛŒØ³Øª</button>

      <div style="display:flex;gap:8px;grid-column:1 / -1;flex-wrap:wrap">
        <button type="button" id="autoFillBtn" class="btn" style="border:1px solid rgba(255,255,255,.15);background:transparent">âš¡ Ù¾Ø±Ú©Ø±Ø¯Ù† Ø®ÙˆØ¯Ú©Ø§Ø±</button>
        <button type="button" id="saveFoodBtn" class="btn" style="border:1px solid rgba(255,255,255,.15);background:transparent">ğŸ’¾ Ø°Ø®ÛŒØ±Ù‡ ØºØ°Ø§</button>
      </div>
    </form>

    <div class="footer-actions">
      <div class="hint">Ù†Ú©ØªÙ‡: Ù„Ø§Ø²Ù… Ù†ÛŒØ³Øª Ø¯Ù‚ÛŒÙ‚ Ø¨Ø§Ø´Ù‡â€”Ø­Ø¯ÙˆØ¯ÛŒ Ù‡Ù… ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒ Ú©Ù…Ú© Ù…ÛŒâ€ŒÚ©Ù†Ù‡ Ù¾ÛŒØ´Ø±ÙØªØª Ø±Ùˆ Ø¨Ø¨ÛŒÙ†ÛŒ.</div>
    </div>
    <div class="log" id="log"></div>
  </div>

  <div class="card" id="historyCard">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px">
      <div style="font-weight:800">ØªØ§Ø±ÛŒØ®Ú†Ù‡ (Û· Ø±ÙˆØ² Ø§Ø®ÛŒØ±)</div>
      <button id="clearHistory" class="btn" style="font-size:13px;border:1px solid rgba(255,255,255,.1);background:transparent">Ù¾Ø§Ú©â€ŒÚ©Ø±Ø¯Ù†</button>
    </div>
    <div id="historyList" class="log"></div>
  </div>

  <div class="tiny">Ù‡Ø¯Ùâ€ŒÙ‡Ø§ Ù‚Ø§Ø¨Ù„ ÙˆÛŒØ±Ø§ÛŒØ´ Ù‡Ø³ØªÙ†Ø¯. Ø¨Ø§ Â«Ø±ÛŒØ³ØªÂ» ÙÙ‚Ø· Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ø§Ù…Ø±ÙˆØ² ØµÙØ± Ù…ÛŒâ€ŒØ´ÙˆØ¯.</div>
</div>

<div class="toast" id="toast"><div>Ø¨Ø§Ø±ÛŒÚ©Ù„Ø§ Ù‚Ù‡Ø±Ù…Ø§Ù†! ğŸ‰</div></div>

<!-- Service Worker -->
<script>
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('./sw.js').catch(console.error);
  });
}
</script>

<!-- Main logic -->
<script>
(() => {
  /* ---------- GOALS ---------- */
  const GOALS_KEY = 'nutri-tracker-goals-v1';
  const DEFAULT_GOALS = { calories: 3000, protein: 176 };
  const loadGoals = () => { try { return JSON.parse(localStorage.getItem(GOALS_KEY)) || DEFAULT_GOALS } catch { return DEFAULT_GOALS } };
  const saveGoals = g => localStorage.setItem(GOALS_KEY, JSON.stringify(g));
  let GOALS = loadGoals();

  /* ---------- STATE & HISTORY ---------- */
  const STATE_KEY = 'nutri-tracker-state-v2';
  const HISTORY_KEY = 'nutri-tracker-history-v1';

  /* ---------- FOOD DB ---------- */
  const FOOD_DB_KEY = 'nutri-food-db-v1';
  const FOOD_DB_DEFAULT = {
    'Ù…ÙˆØ² (Û± Ø¹Ø¯Ø¯ Ù…ØªÙˆØ³Ø·)': { cal:105, pro:1.3 },
    'Ø³ÛŒØ¨ (Û± Ø¹Ø¯Ø¯ Ù…ØªÙˆØ³Ø·)': { cal:95, pro:0.5 },
    'ØªØ®Ù…â€ŒÙ…Ø±Øº (Û± Ø¹Ø¯Ø¯ Ø¯Ø±Ø´Øª)': { cal:78, pro:6 },
    'Ù¾Ø±ÙˆØªØ¦ÛŒÙ† ÙˆÛŒ (Û± Ø§Ø³Ú©ÙˆÙ¾)': { cal:120, pro:24 },
    'Ø³ÛŒÙ†Ù‡ Ù…Ø±Øº (Û±Û°Û° Ú¯Ø±Ù… Ù¾Ø®ØªÙ‡)': { cal:165, pro:31 },
    'Ø¨Ø±Ù†Ø¬ Ù¾Ø®ØªÙ‡ (Û± Ù¾ÛŒÙ…Ø§Ù†Ù‡)': { cal:206, pro:4.3 },
    'Ø´ÛŒØ± Ù¾Ø±Ú†Ø±Ø¨ (Û± Ù„ÛŒÙˆØ§Ù†)': { cal:149, pro:7.7 },
    'Ú©ÙˆØ¨ÛŒØ¯Ù‡ Ú¯ÙˆØ³ÙÙ†Ø¯ÛŒ (Û±Û±Û° Ú¯Ø±Ù…)': { cal:280, pro:20 }
  };
  const loadFoodDB = () => { try { const r = localStorage.getItem(FOOD_DB_KEY); return r ? JSON.parse(r) : { ...FOOD_DB_DEFAULT } } catch { return { ...FOOD_DB_DEFAULT } } };
  const saveFoodDB = db => localStorage.setItem(FOOD_DB_KEY, JSON.stringify(db));
  let FOOD_DB = loadFoodDB();

  /* ---------- EL REFS ---------- */
  const els = {
    calorieGoal: document.getElementById('calorieGoal'),
    proteinGoal: document.getElementById('proteinGoal'),
    calorieTotal: document.getElementById('calorieTotal'),
    proteinTotal: document.getElementById('proteinTotal'),
    calorieRemain: document.getElementById('calorieRemain'),
    proteinRemain: document.getElementById('proteinRemain'),
    caloriePercent: document.getElementById('caloriePercent'),
    proteinPercent: document.getElementById('proteinPercent'),
    calorieFill: document.getElementById('calorieFill'),
    proteinFill: document.getElementById('proteinFill'),
    form: document.getElementById('addForm'),
    mealName: document.getElementById('mealName'),
    calories: document.getElementById('calories'),
    protein: document.getElementById('protein'),
    log: document.getElementById('log'),
    resetBtn: document.getElementById('resetBtn'),
    toast: document.getElementById('toast'),
    historyList: document.getElementById('historyList'),
    clearHistory: document.getElementById('clearHistory'),
    foodList: document.getElementById('foodList'),
    autoFillBtn: document.getElementById('autoFillBtn'),
    saveFoodBtn: document.getElementById('saveFoodBtn'),
    goalCal: document.getElementById('goalCal'),
    goalPro: document.getElementById('goalPro'),
    saveGoals: document.getElementById('saveGoals'),
  };

  /* ---------- HELPERS ---------- */
  const todayStr = () => new Date().toISOString().slice(0,10);
  const pct = (n,d) => Math.min(100, d ? n/d*100 : 0);
  const fmt = n => (Math.round((n ?? 0)*100)/100).toString();

  function refreshFoodList(){
    els.foodList.innerHTML = '';
    Object.keys(FOOD_DB).sort((a,b)=>a.localeCompare(b,'fa')).forEach(name=>{
      const opt = document.createElement('option'); opt.value = name; els.foodList.appendChild(opt);
    });
  }
  refreshFoodList();

  function findFood(query){
    if(!query) return null;
    const q = query.trim().toLowerCase();
    for(const name of Object.keys(FOOD_DB)){ if(name.toLowerCase()===q) return { name, ...FOOD_DB[name] } }
    for(const name of Object.keys(FOOD_DB)){ if(name.toLowerCase().includes(q)) return { name, ...FOOD_DB[name] } }
    return null;
  }
  function autoFillFromName(){
    const pick = findFood(els.mealName.value);
    if(!pick) return false;
    els.calories.value = pick.cal;
    els.protein.value = pick.pro;
    els.mealName.value = pick.name;
    return true;
  }

  function defaultState(){ return { date: todayStr(), cal:0, pro:0, log:[], celebrated:false } }
  function loadState(){ try{ return JSON.parse(localStorage.getItem(STATE_KEY)) || defaultState() } catch { return defaultState() } }
  function saveState(s){ localStorage.setItem(STATE_KEY, JSON.stringify(s)) }
  function loadHistory(){ try{ return JSON.parse(localStorage.getItem(HISTORY_KEY)) || {} } catch { return {} } }
  function saveHistory(h){ localStorage.setItem(HISTORY_KEY, JSON.stringify(h)) }
  function summarize(s){
    const calPct = Math.floor(pct(s.cal, GOALS.calories));
    const proPct = Math.floor(pct(s.pro, GOALS.protein));
    const met = s.cal >= GOALS.calories && s.pro >= GOALS.protein;
    return { date:s.date, cal:s.cal, pro:s.pro, calPct, proPct, met, ts:Date.now() };
  }
  function rolloverIfNeeded(){
    let s = loadState();
    const today = todayStr();
    if(s.date !== today){
      const hist = loadHistory();
      if(!hist[s.date]) hist[s.date] = summarize(s);
      saveHistory(hist);
      s = defaultState(); saveState(s);
    }
    return s;
  }

  /* ---------- INIT ---------- */
  els.calorieGoal.textContent = GOALS.calories;
  els.proteinGoal.textContent = GOALS.protein;
  els.goalCal.value = GOALS.calories;
  els.goalPro.value = GOALS.protein;

  let state = rolloverIfNeeded();

  /* ---------- RENDER ---------- */
  function render(){
    els.calorieTotal.textContent = fmt(state.cal);
    els.proteinTotal.textContent = fmt(state.pro);
    const calRemain = Math.max(0, GOALS.calories - state.cal);
    const proRemain = Math.max(0, GOALS.protein - state.pro);
    els.calorieRemain.textContent = fmt(calRemain);
    els.proteinRemain.textContent = fmt(proRemain);
    const calPct = pct(state.cal, GOALS.calories);
    const proPct = pct(state.pro, GOALS.protein);
    els.caloriePercent.textContent = `${Math.floor(calPct)}%`;
    els.proteinPercent.textContent = `${Math.floor(proPct)}%`;
    els.calorieFill.style.width = `${calPct}%`;
    els.proteinFill.style.width = `${proPct}%`;

    els.log.innerHTML = '';
    if(!state.log.length){
      const empty = document.createElement('div'); empty.className='tiny'; empty.textContent='Ù‡Ù†ÙˆØ² Ú†ÛŒØ²ÛŒ ÙˆØ§Ø±Ø¯ Ù†Ú©Ø±Ø¯ÛŒ.'; els.log.appendChild(empty);
    }else{
      state.log.slice().reverse().forEach(item=>{
        const row = document.createElement('div'); row.className='log-item';
        const left = document.createElement('div');
        left.innerHTML = `<div class="log-nums">${fmt(item.cal)} Ú©Ø§Ù„Ø±ÛŒ â€¢ ${fmt(item.pro)} Ú¯Ø±Ù… Ù¾Ø±ÙˆØªØ¦ÛŒÙ†</div>
                          <div class="log-meta">${item.name ? item.name + ' â€¢ ' : ''}${new Date(item.time).toLocaleTimeString('fa-IR',{hour:'2-digit',minute:'2-digit'})}</div>`;
        const del = document.createElement('button');
        del.className='btn'; del.style.cssText='background:transparent;color:#fca5a5;border:1px solid rgba(239,68,68,.35);font-size:13px';
        del.textContent='Ø­Ø°Ù';
        del.onclick=()=>{
          if(!confirm('Ø¢ÛŒØ§ Ù…Ø·Ù…Ø¦Ù†ÛŒ Ù…ÛŒâ€ŒØ®ÙˆØ§ÛŒ Ø§ÛŒÙ† Ù…ÙˆØ±Ø¯ Ø­Ø°Ù Ø´ÙˆØ¯ØŸ')) return;
          state.cal -= item.cal; state.pro -= item.pro;
          state.log = state.log.filter(x=>x.id!==item.id);
          if(state.cal<GOALS.calories || state.pro<GOALS.protein) state.celebrated=false;
          saveState(state); render();
        };
        row.appendChild(left); row.appendChild(del); els.log.appendChild(row);
      });
    }

    if(!state.celebrated && state.cal>=GOALS.calories && state.pro>=GOALS.protein){
      state.celebrated=true; saveState(state); showToast();
    }
    renderHistory();
  }

  function showToast(){ els.toast.classList.add('show'); setTimeout(()=>els.toast.classList.remove('show'),2500); }

  function renderHistory(){
    const hist = loadHistory(); const dates = Object.keys(hist).sort().reverse(); const last7 = dates.slice(0,7);
    els.historyList.innerHTML='';
    if(!last7.length){
      const empty=document.createElement('div'); empty.className='tiny'; empty.textContent='Ù‡Ù†ÙˆØ² Ø±ÙˆØ² Ù‚Ø¨Ù„ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡.'; els.historyList.appendChild(empty); return;
    }
    last7.forEach(d=>{
      const h=hist[d]; const row=document.createElement('div'); row.className='log-item'; row.style.flexDirection='column';
      row.innerHTML = `
        <div style="display:flex;justify-content:space-between;width:100%">
          <div style="font-weight:700">${d}</div>
          <div class="tiny">${h.met ? 'âœ… Ø§Ù‡Ø¯Ø§Ù ØªÚ©Ù…ÛŒÙ„ Ø´Ø¯' : 'â³ Ù‡Ù†ÙˆØ² ØªÚ©Ù…ÛŒÙ„ Ù†Ø´Ø¯Ù‡'}</div>
        </div>
        <div class="tiny">Ú©Ø§Ù„Ø±ÛŒ: ${fmt(h.cal)} (${h.calPct}Ùª) â€¢ Ù¾Ø±ÙˆØªØ¦ÛŒÙ†: ${fmt(h.pro)} (${h.proPct}Ùª)</div>
        <div class="bar" style="margin-top:6px"><div class="fill" style="width:${Math.min(100,h.calPct)}%"></div></div>
        <div class="bar" style="margin-top:6px"><div class="fill" style="width:${Math.min(100,h.proPct)}%"></div></div>`;
      els.historyList.appendChild(row);
    });
  }

  /* ---------- EVENTS ---------- */
  els.form.addEventListener('submit', e=>{
    e.preventDefault();
    if(state.date!==todayStr()) state = rolloverIfNeeded();
    const cal = Number(els.calories.value), pro = Number(els.protein.value), name=(els.mealName.value||'').trim();
    if(!((cal>=0)&&(pro>=0)) || (cal===0 && pro===0)) return;
    const entry = { id: crypto.randomUUID?crypto.randomUUID():String(Date.now()+Math.random()), name, cal, pro, time:Date.now() };
    state.cal += cal; state.pro += pro; state.log.push(entry); saveState(state); render();
    els.calories.value=''; els.protein.value=''; els.mealName.value=''; els.calories.focus();
  });

  els.resetBtn.addEventListener('click', ()=>{
    if(!confirm('Ù‡Ù…Ù‡â€ŒÛŒ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ø§Ù…Ø±ÙˆØ² Ù¾Ø§Ú© Ø´ÙˆØ¯ØŸ')) return;
    state = { date: todayStr(), cal:0, pro:0, log:[], celebrated:false }; saveState(state); render();
  });

  if(els.clearHistory){
    els.clearHistory.addEventListener('click', ()=>{
      if(!confirm('Ù‡Ù…Ù‡â€ŒÛŒ Ø±ÙˆØ²Ù‡Ø§ÛŒ Ú¯Ø°Ø´ØªÙ‡ Ø§Ø² ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ø­Ø°Ù Ø´ÙˆØ¯ØŸ')) return;
      saveHistory({}); renderHistory();
    });
  }

  /* ---- Auto-fill behavior (no fill while typing) ---- */
  function optionExistsExact(val){
    const opts = els.foodList.options;
    for(let i=0;i<opts.length;i++){
      if((opts[i].value||'').trim().toLowerCase() === (val||'').trim().toLowerCase()) return true;
    }
    return false;
  }
  // ÙÙ‚Ø· ÙˆÙ‚ØªÛŒ Ø§Ø² ÙÙ‡Ø±Ø³Øª ÙˆØ§Ù‚Ø¹Ø§Ù‹ Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ø¯ØŒ Ø¨Ø§ ØªØ£ÛŒÛŒØ¯ Ú©Ø§Ø±Ø¨Ø± Ù¾Ø± Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ…
  els.mealName.addEventListener('change', ()=>{
    const v = els.mealName.value;
    if(optionExistsExact(v)){
      if(confirm('Ø§ÛŒÙ† Ù…ÙˆØ±Ø¯ Ø¯Ø± ÙÙ‡Ø±Ø³Øª Ù…ÙˆØ¬ÙˆØ¯ Ø§Ø³Øª. Ù…Ù‚Ø§Ø¯ÛŒØ± Ù¾Ø± Ø´ÙˆØ¯ØŸ')){
        autoFillFromName();
      }
    }
  });
  // Ø¯Ú©Ù…Ù‡â€ŒÛŒ Ù¾Ø±Ú©Ø±Ø¯Ù† Ø®ÙˆØ¯Ú©Ø§Ø±
  els.autoFillBtn.addEventListener('click', ()=>{
    if(!autoFillFromName()){
      alert('Ø¯Ø± ÙÙ‡Ø±Ø³Øª ØºØ°Ø§Ù‡Ø§ Ù…ÙˆØ±Ø¯ÛŒ Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯. Ø§Ø¨ØªØ¯Ø§ Ø°Ø®ÛŒØ±Ù‡â€ŒØ§Ø´ Ú©Ù†.');
    }
  });
  // Ø°Ø®ÛŒØ±Ù‡â€ŒÛŒ ØºØ°Ø§
  els.saveFoodBtn.addEventListener('click', ()=>{
    const name=(els.mealName.value||'').trim(), cal=Number(els.calories.value), pro=Number(els.protein.value);
    if(!name) return alert('Ø§ÙˆÙ„ Ù†Ø§Ù… ØºØ°Ø§ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†.');
    if(!(cal>0 || pro>0)) return alert('Ú©Ø§Ù„Ø±ÛŒ ÛŒØ§ Ù¾Ø±ÙˆØªØ¦ÛŒÙ† Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù† ØªØ§ Ø°Ø®ÛŒØ±Ù‡ Ø´ÙˆØ¯.');
    FOOD_DB[name]={cal,pro}; saveFoodDB(FOOD_DB); refreshFoodList(); alert('Ø¨Ù‡ ÙÙ‡Ø±Ø³Øª ØºØ°Ø§Ù‡Ø§ÛŒ Ø´Ù…Ø§ Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯ âœ…');
  });

  // ØªÙ†Ø¸ÛŒÙ… Ùˆ Ø°Ø®ÛŒØ±Ù‡ Ø§Ù‡Ø¯Ø§Ù
  els.saveGoals.addEventListener('click', ()=>{
    const c = Math.max(0, +els.goalCal.value || DEFAULT_GOALS.calories);
    const p = Math.max(0, +els.goalPro.value || DEFAULT_GOALS.protein);
    GOALS = { calories:c, protein:p }; saveGoals(GOALS);
    els.calorieGoal.textContent = GOALS.calories; els.proteinGoal.textContent = GOALS.protein; render();
    alert('âœ… Ù‡Ø¯Ù Ø¬Ø¯ÛŒØ¯ Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯');
  });

  // Ù‡Ù†Ú¯Ø§Ù… Ø®Ø±ÙˆØ¬ Ø®Ù„Ø§ØµÙ‡Ù” Ø§Ù…Ø±ÙˆØ² Ø±Ø§ Ø¯Ø± ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ø«Ø¨Øª Ú©Ù†
  window.addEventListener('beforeunload', ()=>{
    if((state.cal>0 || state.pro>0) && state.date===todayStr()){
      const hist = loadHistory(); hist[state.date]=summarize(state); saveHistory(hist);
    }
  });

  render();
})();
</script>
</body>
</html>
