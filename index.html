<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ردیاب کالری و پروتئین</title>

<!-- PWA -->
<link rel="manifest" href="manifest.webmanifest">
<meta name="theme-color" content="#0f172a">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<link rel="apple-touch-icon" href="icons/icon-192.png">

<style>
  :root{
    --bg:#0f172a; --card:#111827; --muted:#94a3b8; --text:#e5e7eb;
    --blue:#3b82f6; --track:#1f2937; --accent:#22c55e; --danger:#ef4444;
  }
  *{box-sizing:border-box}
  body{margin:0; padding:24px; background: radial-gradient(1200px 800px at 100% -10%, #0b1225, var(--bg));
       color:var(--text); font-family:"Vazirmatn",system-ui,-apple-system,Segoe UI,Roboto,"Noto Naskh Arabic",Tahoma,Arial,sans-serif;}
  .container{max-width:760px;margin:0 auto;display:flex;flex-direction:column;gap:18px;}
  .header{display:flex;align-items:flex-start;justify-content:space-between;gap:16px;flex-wrap:wrap}
  h1{margin:0;font-size:22px;font-weight:800;letter-spacing:-0.3px}
  .card{background:linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.01));
        border:1px solid rgba(255,255,255,0.06); border-radius:16px; padding:16px; backdrop-filter: blur(6px);}
  .goals{display:grid;grid-template-columns:1fr;gap:12px;}
  @media (min-width:700px){.goals{grid-template-columns:1fr 1fr;}}
  .progress{display:flex;flex-direction:column;gap:8px;}
  .label-row{display:flex;align-items:baseline;justify-content:space-between;gap:8px;color:var(--muted);font-size:14px;}
  .bar{position:relative;width:100%;height:16px;background:var(--track);border-radius:999px;overflow:hidden;outline:1px solid rgba(255,255,255,0.05);}
  .fill{position:absolute;inset:0 0 0 auto;width:0%;background:linear-gradient(90deg,#60a5fa,var(--blue));
        box-shadow:0 0 12px rgba(59,130,246,.5) inset;border-radius:999px;transition:width .35s ease;}
  .stats{display:flex;gap:10px;flex-wrap:wrap;font-size:13px;color:var(--muted);}
  .pill{padding:6px 10px;border:1px solid rgba(255,255,255,0.08);border-radius:999px;background:rgba(255,255,255,0.03)}
  .form{display:grid;grid-template-columns:1fr;gap:12px;}
  @media (min-width:520px){.form{grid-template-columns:repeat(3,1fr);}}
  .field{display:flex;flex-direction:column;gap:6px;}
  label{font-size:13px;color:var(--muted)}
  input{background:#0b1220;color:var(--text);border:1px solid rgba(255,255,255,0.08);
        border-radius:12px;padding:12px 10px;font-size:16px;outline:none;}
  input:focus{border-color:#60a5fa;box-shadow:0 0 0 4px rgba(59,130,246,.15)}
  .btn{cursor:pointer;border:none;padding:12px 14px;border-radius:12px;font-size:16px;font-weight:700;}
  .btn-primary{background:var(--blue);color:white}
  .btn-danger{background:transparent;color:#fecaca;border:1px dashed rgba(239,68,68,.5)}
  .footer-actions{display:flex;gap:10px;flex-wrap:wrap;justify-content:space-between;align-items:center}
  .hint{color:var(--muted);font-size:12px}
  .log{display:flex;flex-direction:column;gap:8px;max-height:240px;overflow:auto;border-top:1px solid rgba(255,255,255,0.06);padding-top:10px}
  .log-item{display:flex;justify-content:space-between;align-items:center;gap:10px;padding:10px;border:1px solid rgba(255,255,255,0.06);border-radius:12px;background:rgba(255,255,255,0.02);}
  .log-meta{font-size:13px;color:var(--muted)}
  .log-nums{font-weight:700}
  .toast{position:fixed;inset:auto 0 24px 0;display:flex;justify-content:center;pointer-events:none;}
  .toast>div{background:linear-gradient(90deg,#16a34a,#22c55e);color:white;font-weight:900;letter-spacing:.5px;padding:14px 18px;border-radius:999px;box-shadow:0 10px 30px rgba(0,0,0,.35);transform:translateY(32px);opacity:0;transition:all .4s ease;}
  .toast.show>div{transform:translateY(0);opacity:1}
  .tiny{font-size:12px;color:var(--muted)}
  #goalSettings input{background:#0b1220;border:1px solid rgba(255,255,255,.08);color:var(--text)}
</style>
</head>
<body>
<div class="container">
  <div class="header">
    <h1>ردیاب روزانه کالری و پروتئین</h1>
    <div style="display:flex;gap:10px;align-items:flex-start;flex-wrap:wrap">
      <button id="resetBtn" class="btn btn-danger">ریست</button>
      <div id="goalSettings" style="display:flex;gap:8px;flex-wrap:wrap">
        <input id="goalCal" type="number" min="0" placeholder="هدف کالری" style="width:120px;padding:8px;border-radius:8px">
        <input id="goalPro" type="number" min="0" placeholder="هدف پروتئین" style="width:120px;padding:8px;border-radius:8px">
        <button id="saveGoals" class="btn" style="font-size:13px">ذخیره هدف</button>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="goals">
      <div class="progress" id="calorieSection">
        <div class="label-row">
          <div>کالری امروز</div>
          <div class="tiny"><span id="calorieTotal">0</span> / <span id="calorieGoal">3000</span> کیلوکالری</div>
        </div>
        <div class="bar"><div class="fill" id="calorieFill"></div></div>
        <div class="stats">
          <span class="pill">باقی‌مانده: <b id="calorieRemain">3000</b></span>
          <span class="pill">پیشرفت: <b id="caloriePercent">0%</b></span>
        </div>
      </div>

      <div class="progress" id="proteinSection">
        <div class="label-row">
          <div>پروتئین امروز</div>
          <div class="tiny"><span id="proteinTotal">0</span> / <span id="proteinGoal">176</span> گرم</div>
        </div>
        <div class="bar"><div class="fill" id="proteinFill"></div></div>
        <div class="stats">
          <span class="pill">باقی‌مانده: <b id="proteinRemain">176</b></span>
          <span class="pill">پیشرفت: <b id="proteinPercent">0%</b></span>
        </div>
      </div>
    </div>
  </div>

  <div class="card">
    <form id="addForm" class="form" autocomplete="off">
      <div class="field">
        <label for="mealName">نام غذا / وعده</label>
        <input id="mealName" type="text" list="foodList" placeholder="مثلاً: موز، تخم‌مرغ، سینه مرغ..." />
        <datalist id="foodList"></datalist>
        <div class="tiny">نکته: نام غذا را شروع کن بنویس؛ اگر در فهرست باشد، کالری و پروتئین فقط با انتخاب یا دکمه پر می‌شود.</div>
      </div>

      <div class="field">
        <label for="calories">کالری (کیلوکالری)</label>
        <input id="calories" inputmode="decimal" type="number" min="0" step="1" placeholder="مثلاً ۱۰۵" required />
      </div>

      <div class="field">
        <label for="protein">پروتئین (گرم)</label>
        <input id="protein" inputmode="decimal" type="number" min="0" step="0.1" placeholder="مثلاً ۱٫۳" required />
      </div>

      <button class="btn btn-primary" type="submit" style="grid-column: 1 / -1">افزودن به لیست</button>

      <div style="display:flex;gap:8px;grid-column:1 / -1;flex-wrap:wrap">
        <button type="button" id="autoFillBtn" class="btn" style="border:1px solid rgba(255,255,255,.15);background:transparent">⚡ پرکردن خودکار</button>
        <button type="button" id="saveFoodBtn" class="btn" style="border:1px solid rgba(255,255,255,.15);background:transparent">💾 ذخیره غذا</button>
      </div>
    </form>

    <div class="footer-actions">
      <div class="hint">نکته: لازم نیست دقیق باشه—حدودی هم وارد کنی کمک می‌کنه پیشرفتت رو ببینی.</div>
    </div>
    <div class="log" id="log"></div>
  </div>

  <div class="card" id="historyCard">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px">
      <div style="font-weight:800">تاریخچه (۷ روز اخیر)</div>
      <button id="clearHistory" class="btn" style="font-size:13px;border:1px solid rgba(255,255,255,.1);background:transparent">پاک‌کردن</button>
    </div>
    <div id="historyList" class="log"></div>
  </div>

  <div class="tiny">هدف‌ها قابل ویرایش هستند. با «ریست» فقط داده‌های امروز صفر می‌شود.</div>
</div>

<div class="toast" id="toast"><div>باریکلا قهرمان! 🎉</div></div>

<script>
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('./sw.js').catch(console.error);
  });
}
</script>

<script>
(() => {
  // ... (همه‌ی منطق قبلی اهداف، تاریخچه و DB غذا)
  // فقط این بخش auto-fill تغییر کرده:

  function autoFillFromName(){ /* همان قبلی */ }

  // ❌ حذف شد: autoFill هنگام تایپ

  // ✅ فقط وقتی از لیست انتخاب شود
  function optionExistsExact(val){
    const opts = els.foodList.options;
    for(let i=0;i<opts.length;i++){
      if((opts[i].value||'').trim().toLowerCase() === (val||'').trim().toLowerCase()) return true;
    }
    return false;
  }
  els.mealName.addEventListener('change', ()=>{
    const v = els.mealName.value;
    if(optionExistsExact(v)){
      if(confirm('این مورد در فهرست موجود است. مقادیر پر شود؟')){
        autoFillFromName();
      }
    }
  });

  // دکمه پرکردن خودکار
  els.autoFillBtn.addEventListener('click', ()=>{
    if(!autoFillFromName()){
      alert('در فهرست غذاها موردی پیدا نشد. ابتدا ذخیره‌اش کن.');
    }
  });

})();
</script>
</body>
</html>
