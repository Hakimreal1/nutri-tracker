<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ردیاب کالری و پروتئین</title>

<!-- 🔹 PWA -->
<link rel="manifest" href="manifest.webmanifest">
<meta name="theme-color" content="#0f172a">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<link rel="apple-touch-icon" href="icons/icon-192.png">

<style>
  :root{
    --bg:#0f172a;
    --card:#111827;
    --muted:#94a3b8;
    --text:#e5e7eb;
    --blue:#3b82f6;
    --track:#1f2937;
    --accent:#22c55e;
    --danger:#ef4444;
  }
  *{box-sizing:border-box}
  body{margin:0; padding:24px; background: radial-gradient(1200px 800px at 100% -10%, #0b1225, var(--bg)); color:var(--text); font-family:"Vazirmatn",system-ui,-apple-system,Segoe UI,Roboto,"Noto Naskh Arabic",Tahoma,Arial,sans-serif;}
  .container{max-width:760px;margin:0 auto;display:flex;flex-direction:column;gap:18px;}
  .header{display:flex;align-items:center;justify-content:space-between;gap:16px;}
  h1{margin:0;font-size:22px;font-weight:800;letter-spacing:-0.3px}
  .card{background:linear-gradient(180deg,rgba(255,255,255,0.03),rgba(255,255,255,0.01));border:1px solid rgba(255,255,255,0.06);border-radius:16px;padding:16px;backdrop-filter:blur(6px);}
  .goals{display:grid;grid-template-columns:1fr;gap:12px;}
  @media (min-width:700px){.goals{grid-template-columns:1fr 1fr;}}
  .progress{display:flex;flex-direction:column;gap:8px;}
  .label-row{display:flex;align-items:baseline;justify-content:space-between;gap:8px;color:var(--muted);font-size:14px;}
  .bar{position:relative;width:100%;height:16px;background:var(--track);border-radius:999px;overflow:hidden;outline:1px solid rgba(255,255,255,0.05);}
  .fill{position:absolute;inset:0 0 0 auto;width:0%;background:linear-gradient(90deg,#60a5fa,var(--blue));box-shadow:0 0 12px rgba(59,130,246,.5) inset;border-radius:999px;transition:width .35s ease;}
  .stats{display:flex;gap:10px;flex-wrap:wrap;font-size:13px;color:var(--muted);}
  .pill{padding:6px 10px;border:1px solid rgba(255,255,255,0.08);border-radius:999px;background:rgba(255,255,255,0.03)}
  .form{display:grid;grid-template-columns:1fr;gap:12px;}
  @media (min-width:520px){.form{grid-template-columns:repeat(3,1fr);}}
  .field{display:flex;flex-direction:column;gap:6px;}
  label{font-size:13px;color:var(--muted)}
  input{background:#0b1220;color:var(--text);border:1px solid rgba(255,255,255,0.08);border-radius:12px;padding:12px 10px;font-size:16px;outline:none;}
  input:focus{border-color:#60a5fa;box-shadow:0 0 0 4px rgba(59,130,246,.15)}
  .btn{cursor:pointer;border:none;padding:12px 14px;border-radius:12px;font-size:16px;font-weight:700;}
  .btn-primary{background:var(--blue);color:white}
  .btn-danger{background:transparent;color:#fecaca;border:1px dashed rgba(239,68,68,.5)}
  .footer-actions{display:flex;gap:10px;flex-wrap:wrap;justify-content:space-between;align-items:center}
  .hint{color:var(--muted);font-size:12px}
  .log{display:flex;flex-direction:column;gap:8px;max-height:240px;overflow:auto;border-top:1px solid rgba(255,255,255,0.06);padding-top:10px}
  .log-item{display:flex;justify-content:space-between;align-items:center;gap:10px;padding:10px;border:1px solid rgba(255,255,255,0.06);border-radius:12px;background:rgba(255,255,255,0.02);}
  .log-meta{font-size:13px;color:var(--muted)}
  .log-nums{font-weight:700}
  .toast{position:fixed;inset:auto 0 24px 0;display:flex;justify-content:center;pointer-events:none;}
  .toast>div{background:linear-gradient(90deg,#16a34a,#22c55e);color:white;font-weight:900;letter-spacing:.5px;padding:14px 18px;border-radius:999px;box-shadow:0 10px 30px rgba(0,0,0,.35);transform:translateY(32px);opacity:0;transition:all .4s ease;}
  .toast.show>div{transform:translateY(0);opacity:1}
  .tiny{font-size:12px;color:var(--muted)}
</style>
</head>
<body>
<div class="container">
  <div class="header">
    <h1>ردیاب روزانه کالری و پروتئین</h1>
    <button id="resetBtn" class="btn btn-danger">ریست</button>
  </div>

  <div class="card">
    <div class="goals">
      <div class="progress">
        <div class="label-row"><div>کالری امروز</div><div class="tiny"><span id="calorieTotal">0</span> / <span id="calorieGoal">3000</span></div></div>
        <div class="bar"><div class="fill" id="calorieFill"></div></div>
        <div class="stats"><span class="pill">Remaining: <b id="calorieRemain">3000</b></span><span class="pill">Progress: <b id="caloriePercent">0%</b></span></div>
      </div>
      <div class="progress">
        <div class="label-row"><div>پروتئین امروز</div><div class="tiny"><span id="proteinTotal">0</span> / <span id="proteinGoal">176</span></div></div>
        <div class="bar"><div class="fill" id="proteinFill"></div></div>
        <div class="stats"><span class="pill">Remaining: <b id="proteinRemain">176</b></span><span class="pill">Progress: <b id="proteinPercent">0%</b></span></div>
      </div>
    </div>
  </div>

  <div class="card">
    <form id="addForm" class="form">
      <div class="field"><label>نام وعده (اختیاری)</label><input id="mealName" type="text" placeholder="مثلاً شیک وی، چلوکباب، املت..." /></div>
      <div class="field"><label>کالری</label><input id="calories" type="number" min="0" /></div>
      <div class="field"><label>پروتئین</label><input id="protein" type="number" min="0" /></div>
      <button class="btn btn-primary" type="submit" style="grid-column:1/-1">افزودن وعده</button>
    </form>
    <div class="footer-actions"><div class="hint">نکته: لازم نیست دقیق باشه—حدودی هم وارد کنی کمک می‌کنه.</div></div>
    <div class="log" id="log"></div>
  </div>

  <div class="tiny">هدف‌ها: کالری ۳۰۰۰ و پروتئین ۱۷۶. با «ریست» همه‌چیز صفر می‌شود.</div>
</div>

<div class="toast" id="toast"><div>باریکلا قهرمان! 🎉</div></div>

<!-- Service Worker register -->
<script>
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('./sw.js').catch(console.error);
  });
}
</script>

<script>
(() => {
  // ---- CONFIG ----
  const GOALS = { calories: 3000, protein: 176 };
  const STATE_KEY = 'nutri-tracker-state-v2';   // per-day live state
  const HISTORY_KEY = 'nutri-tracker-history-v1'; // map of date -> summary

  // ---- EL REFS ----
  const els = {
    calorieGoal: document.getElementById('calorieGoal'),
    proteinGoal: document.getElementById('proteinGoal'),
    calorieTotal: document.getElementById('calorieTotal'),
    proteinTotal: document.getElementById('proteinTotal'),
    calorieRemain: document.getElementById('calorieRemain'),
    proteinRemain: document.getElementById('proteinRemain'),
    caloriePercent: document.getElementById('caloriePercent'),
    proteinPercent: document.getElementById('proteinPercent'),
    calorieFill: document.getElementById('calorieFill'),
    proteinFill: document.getElementById('proteinFill'),
    form: document.getElementById('addForm'),
    mealName: document.getElementById('mealName'),
    calories: document.getElementById('calories'),
    protein: document.getElementById('protein'),
    log: document.getElementById('log'),
    resetBtn: document.getElementById('resetBtn'),
    toast: document.getElementById('toast'),
    historyList: document.getElementById('historyList'),
    clearHistory: document.getElementById('clearHistory'),
  };

  // ---- HELPERS ----
  const todayStr = () => new Date().toISOString().slice(0,10); // YYYY-MM-DD in local tz basis
  const pct = (num, den) => Math.min(100, den ? (num/den*100) : 0);
  const fmt = n => (Math.round((n ?? 0)*100)/100).toString();

  const defaultState = () => ({ date: todayStr(), cal: 0, pro: 0, log: [], celebrated: false });

  const loadState = () => {
    try { return JSON.parse(localStorage.getItem(STATE_KEY)) || defaultState(); }
    catch { return defaultState(); }
  };
  const saveState = s => localStorage.setItem(STATE_KEY, JSON.stringify(s));

  const loadHistory = () => {
    try { return JSON.parse(localStorage.getItem(HISTORY_KEY)) || {}; }
    catch { return {}; }
  };
  const saveHistory = h => localStorage.setItem(HISTORY_KEY, JSON.stringify(h));

  // Summarize a day for history
  const summarize = (s) => {
    const calPct = Math.floor(pct(s.cal, GOALS.calories));
    const proPct = Math.floor(pct(s.pro, GOALS.protein));
    const met = s.cal >= GOALS.calories && s.pro >= GOALS.protein;
    return {
      date: s.date,
      cal: s.cal, pro: s.pro,
      calPct, proPct,
      met,
      ts: Date.now()
    };
  };

  // Put yesterday into history if we rolled over
  function rolloverIfNeeded() {
    let s = loadState();
    const today = todayStr();
    if (s.date !== today) {
      // Save previous day into history
      const hist = loadHistory();
      if (!hist[s.date]) hist[s.date] = summarize(s);
      saveHistory(hist);
      // Start a new day
      s = defaultState();
      saveState(s);
    }
    return s;
  }

  // ---- INIT ----
  els.calorieGoal.textContent = GOALS.calories;
  els.proteinGoal.textContent = GOALS.protein;

  let state = rolloverIfNeeded();

  // ---- RENDER ----
  function render() {
    // totals
    els.calorieTotal.textContent = fmt(state.cal);
    els.proteinTotal.textContent = fmt(state.pro);
    // remaining
    const calRemain = Math.max(0, GOALS.calories - state.cal);
    const proRemain = Math.max(0, GOALS.protein - state.pro);
    els.calorieRemain.textContent = fmt(calRemain);
    els.proteinRemain.textContent = fmt(proRemain);
    // percents
    const calPct = pct(state.cal, GOALS.calories);
    const proPct = pct(state.pro, GOALS.protein);
    els.caloriePercent.textContent = `${Math.floor(calPct)}%`;
    els.proteinPercent.textContent = `${Math.floor(proPct)}%`;
    els.calorieFill.style.width = `${calPct}%`;
    els.proteinFill.style.width = `${proPct}%`;

    // log
    els.log.innerHTML = '';
    if (!state.log.length) {
      const empty = document.createElement('div');
      empty.className = 'tiny';
      empty.textContent = 'هنوز چیزی وارد نکردی.';
      els.log.appendChild(empty);
    } else {
      state.log.slice().reverse().forEach(item => {
        const row = document.createElement('div');
        row.className = 'log-item';
        const left = document.createElement('div');
        left.innerHTML =
          `<div class="log-nums">${fmt(item.cal)} کالری • ${fmt(item.pro)} گرم پروتئین</div>
           <div class="log-meta">${item.name ? item.name + ' • ' : ''}${new Date(item.time).toLocaleTimeString('fa-IR',{hour:'2-digit',minute:'2-digit'})}</div>`;
        const del = document.createElement('button');
        del.className = 'btn';
        del.style.cssText = 'background:transparent;color:#fca5a5;border:1px solid rgba(239,68,68,.35);font-size:13px';
        del.textContent = 'حذف';
        del.onclick = () => {
          state.cal -= item.cal; state.pro -= item.pro;
          state.log = state.log.filter(x => x.id !== item.id);
          if (state.cal < GOALS.calories || state.pro < GOALS.protein) state.celebrated = false;
          saveState(state); render();
        };
        row.appendChild(left); row.appendChild(del);
        els.log.appendChild(row);
      });
    }

    // celebrate
    if (!state.celebrated && state.cal >= GOALS.calories && state.pro >= GOALS.protein) {
      state.celebrated = true; saveState(state); showToast();
    }

    renderHistory();
  }

  function showToast() {
    els.toast.classList.add('show');
    setTimeout(() => els.toast.classList.remove('show'), 2500);
  }

  // ---- HISTORY UI ----
  function renderHistory() {
    const hist = loadHistory();
    const dates = Object.keys(hist).sort().reverse(); // newest first
    const last7 = dates.slice(0, 7);
    els.historyList.innerHTML = '';

    if (!last7.length) {
      const empty = document.createElement('div');
      empty.className = 'tiny';
      empty.textContent = 'No previous days yet.';
      els.historyList.appendChild(empty);
      return;
    }

    last7.forEach(d => {
      const h = hist[d];
      const row = document.createElement('div');
      row.className = 'log-item';
      row.style.flexDirection = 'column';
      row.innerHTML = `
        <div style="display:flex;justify-content:space-between;width:100%">
          <div style="font-weight:700">${d}</div>
          <div class="tiny">${h.met ? '✅ Goals met' : '⏳ Not met'}</div>
        </div>
        <div class="tiny">Calories: ${fmt(h.cal)} (${h.calPct}%) • Protein: ${fmt(h.pro)} (${h.proPct}%)</div>
        <div class="bar" style="margin-top:6px"><div class="fill" style="width:${Math.min(100,h.calPct)}%"></div></div>
        <div class="bar" style="margin-top:6px"><div class="fill" style="width:${Math.min(100,h.proPct)}%"></div></div>
      `;
      els.historyList.appendChild(row);
    });
  }

  // ---- EVENTS ----
  els.form.addEventListener('submit', (e) => {
    e.preventDefault();
    // if day changed while page open, rollover now
    if (state.date !== todayStr()) { state = rolloverIfNeeded(); }

    const cal = Number(els.calories.value);
    const pro = Number(els.protein.value);
    const name = (els.mealName.value || '').trim();
    if (!((cal >= 0) && (pro >= 0)) || (cal === 0 && pro === 0)) return;

    const entry = {
      id: crypto.randomUUID ? crypto.randomUUID() : String(Date.now() + Math.random()),
      name, cal, pro, time: Date.now()
    };
    state.cal += cal;
    state.pro += pro;
    state.log.push(entry);
    saveState(state);
    render();
    els.calories.value = ''; els.protein.value = ''; els.calories.focus();
  });

  els.resetBtn.addEventListener('click', () => {
    if (!confirm('همه‌ی داده‌های امروز پاک شود؟')) return;
    state = { date: todayStr(), cal: 0, pro: 0, log: [], celebrated: false };
    saveState(state); render();
  });

  if (els.clearHistory) {
    els.clearHistory.addEventListener('click', () => {
      if (!confirm('Delete all past days from history?')) return;
      saveHistory({}); renderHistory();
    });
  }

  // Also capture today’s summary when user leaves/refreshes
  window.addEventListener('beforeunload', () => {
    // only store if any data today
    if ((state.cal > 0 || state.pro > 0) && state.date === todayStr()) {
      const hist = loadHistory();
      hist[state.date] = summarize(state);
      saveHistory(hist);
    }
  });

  // initial paint
  render();
})();
</script>
